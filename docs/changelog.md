# Change Log

## v5.5.0 ( June 2019 )

### Features

#### Expo Mobile App build and deploy

Adds support for the build and deploy of [Expo](https://expo.io/) based mobile apps
This introduces a new component `mobileapp` which is used to control how the app is deployed. Builds are performed as publish tasks since builds are required for each environment rather than our standard build once deploy many approach
Settings are supported and are made available as constants to the app

Commits

- Mobile app - Add deployment  (#686)
- Add support for multi sdk builds (#689)
- <feat> expo release channel (#700)
- <feat> mobile app settings (#718)

#### Segment units refactoring and updates

The core segment units ( network/vpc, cmk and s3 ) have all been refactored into our occurrence based structure
A few features have also be introduced as part of this

- Networking has now been broken up into two components
  - `network` - This consists of a private network that is made up of subnets, route tables and high level network ACLs for access control between subnets
    - `gateway` - A gateway attaches to a network route table and provides an exit point from the network. We currently support 3 engines
      - `nat` - outbound NAT gateway
      - `igw` - internet gateway which provides public internet access for the network
      - `vpcendpint` - direct connections to cloud provider API endpoints services which are generally available at public endpoints. This includes support for endpoint and gateway vpc endpoints
- A new component has been introduced as the `baseline` component. This component is intended to provide a collection of different resources which must be deployed for any segment to function. This includes the following subcomponents
  - `DataBuckets` - Shared buckets which can be used as standard storage locations for application data and infrastructure logging when a service doesn't use a logging facility ( AWS cloudwatch ). These were the old s3 segment units
  - `Keys` - Shared private keys that are used across a segment. This includes kms keys, ssh keys and CDN keys ( OAI keys for cloudfront to S3)

All segment level unit changes have been made backwards compatible but some extra units need to be added to ensure that it aligns with the new components

When deploying segment units the following units should now be used
**Existing deployments**
`baseline, iam, lg, vpc, vpcendpoint, eip, nat, ssh`

**New deployments**
`baseline, iam, vpc, igw, eip, vpcendpoint, nat, ssh`

All network components are now optional, some dependencies do apply between the components ( igw must be deployed if using nat in AWS)

Commits

- Refactor networking into components (#658)
- <refactor> segment cmk into baseline (#789)
- <feat>Refactor Segment S3 and S3 object notifications (#706)

#### Data Volumes

Data volumes provide a compute independent persistent storage volume which can be attached to compute components, starting with Ec2 and ECS. Volumes also have automated backup policies which will manage snapshotting the volumes

Commits

- Adds support for persistant data volumes on ECS
- extends datavolume support to ec2 (#701)
- <feat> Add automated snapshots with SSM Automation (#703)

#### Config Stores

Config stores provide a DynamoDb based configuration lookup table which is populated using CodeOnTap links and settings. This allows for components to dynamically lookup configuration rather than having to redeploy a component to update its configuration

Commits

- <feat> Config Stores  (#722)
- <feature> config tables - secondary keys

#### Data Feeds

Data feeds are a new component which provides continuous data streams to backend storage services. For AWS this is based on kinesis firehose. The `datafeed` component must have a destination link ( at the moment an `ES` component) and can optionally include logwatchers which link to components and create log subscriptions to logs generated by the component. These are then fed to the Data feed

Commits
- <feat>Elasticsearch logwatcher using kinesis data firehose (#736)
- <refactor>Data feed component (#788)

#### Service Registries

Service registries provide a DNS or API based lookup service which components can register their network access information with. The initial release adds support for private registries which use [AWS Cloud Map](https://aws.amazon.com/cloud-map/) to create a private DNS zone, which can be used for access between services in the same segment. Currently `services` and `lb` components can link to Service registries to provide their network details

Commits

- <feature> Service registries (#794) 

#### User pool federation and client management

Based on some more industrial strength usage of userpools we have made some updates to how user pools are deployed 

- Clients are now a subcomponent of userpools so that you can deploy multiple clients with different authentication flows, and scopes. This is handy if you have a server side authentication and mobile app authentication where flows and scope requirements might differ
- Added support for [user pool federation](https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-identity-federation.html) which allows for a userpool to dynamically create users in the pool based on another auth provider. This is available using the `authprovider` subcomponent on user pools

Commits

- <feat> User pools with multiple clients (#724)
- <feat>Userpool Hosted UI own domain name (#725)
- <feat> Cognito Userpool federation (#730)

#### WAF Updates

Extends our support for WAF to include application inspection rules along with IP and country whitelisting
This includes

- Adding profiles for rules and conditions
- Adding support for regional endpoints ( API Gateway )
- Add ability to define a collection of rules and conditions as waf security profile
- Add basic starter profile which aligns with the [OWASP 2017 Top 10](https://www.owasp.org/index.php/Top_10-2017_Top_10)

Commits

- <refactor> Regional WAF Support (#732)
- <feature> EXpanded WAF Support for API Gateway (#745)
- <refactor> Update WAF support for SPA (#748)

#### API Gateway Updates

A few different updates have been added for API Gateways

- The publish option has been deprecated due to issues we had with S3 bucket name lengths. To replace this functionality we have introduced spec publishers which work with the `contenthub` component to generate a api specification which includes server endpoints and authentication details and copies it to a content hub location. This is intended to work with our newest codeontap family member [townplanner](https://github.com/codeontap/townplanner) which provides a centralised document publishing platform.
- Added support for openapi3 specification integration with our api gateway build process
- Some extra features in our apigateway enrichment process

Commits

- <feature> ApiGateway: spec publishers (#763)
- <feature> Api Gateway - basepath control (#795)
- <feature> apigw: add content handling support (#781)
- <fix> apigw: openapi3 support for security srvs (#782)

#### ECS Fargate support

Support for running ecs services and tasks on [AWS Fargate](https://aws.amazon.com/fargate/)

Commits 

- <feat> ECS Fargate hosting (#704)
- <feature> Fargate scheduled tasks (#716)

#### Extra features

- <feature> Domain inclusions
- <feat> SPA Path based routing to LB (#749)
- update freemarker to 2.3.28 (#784)
- suppurt multi-template location
- jenkins fragment memory configuration (#707)
- <feature>Processor profiles for occurrences
- <feature> Local build commit is preferred over shared (#778)

### Refactor

#### RDS Replacement options

We've added some extra configuration options around RDS restoration and replacement processes to speed things up when you are working with snapshot based rds instances and aren't as worried about the data in the database

Commits

- <feat> RDS Template Polcy management
- <feat> RDS resotre from rds dataset
- <feat> rds replace through delete

#### Other changes

- Remove legacy support for containers (#714)
- <refactor> Force removal of "containerId" use (#728)
- <refactor> templates: remove segment unit control
- <fix> deployment profiles with instance version (#779)
- <refactor> Templates should not depend on tier and component objects (#793)
- Lambda edge functions now use nodejs8.1

### Fixes

- add priority ordering to cfn init scripts (#702)
- <fix> skip network lookups for segment iam
- <fix>dyanmoDb arn formatting (#734)
- fix path for sensitive settings
- <fix> remove alarms when hibernating (#739)
- <bugfix> Conditionally create logmetric resources (#752)
- <refactor>Data pipeline resource creation cleanup (#754)
- <fix> Disable predefined resources which are not required
- <fx> apigw: use cogntio api arn (#783)
- <fix> s3 lifecycle allow for numbers in rules (#792)
